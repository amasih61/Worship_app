<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Worship App - Emmanuel Church</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

  <link rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />

  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#0f172a" />

  <style>
    :root {
      color-scheme: dark;
    }

    body {
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: radial-gradient(circle at top, #1e293b, #020617);
      color: #e5e7eb;
      font-size: 16px;
      transition: background 0.3s ease, color 0.3s ease;
    }

    .scrollbar-thin::-webkit-scrollbar {
      width: 6px;
    }

    .scrollbar-thin::-webkit-scrollbar-thumb {
      background: #4b5563;
      border-radius: 999px;
    }

    .glass {
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.9), rgba(15, 23, 42, 0.85));
      backdrop-filter: blur(22px);
      border: 1px solid rgba(148, 163, 184, 0.3);
      transition: background 0.3s ease, border-color 0.3s ease;
    }

    .chip {
      @apply inline-flex items-center rounded-full px-3 py-1 text-xs font-medium border border-slate-600/60 bg-slate-800/60;
    }

    .btn-primary {
      @apply inline-flex items-center justify-center rounded-xl px-4 py-2 text-sm font-semibold bg-blue-600 hover:bg-blue-500 active:bg-blue-700 text-white transition;
    }

    .btn-ghost {
      @apply inline-flex items-center justify-center rounded-xl px-3 py-2 text-xs font-medium bg-slate-900/60 hover:bg-slate-800/80 border border-slate-700/80 text-slate-200 transition;
    }

    .badge-pill {
      @apply text-[10px] inline-flex items-center px-2 py-0.5 rounded-full bg-slate-800 border border-slate-600 text-slate-300;
    }

    /* Install Button Animation */
    .btn-install {
       @apply hidden inline-flex items-center justify-center rounded-xl px-3 py-1.5 text-xs font-bold bg-emerald-600/20 text-emerald-400 border border-emerald-500/50 animate-pulse gap-2 transition;
    }

    /* ========== LIGHT MODE STYLES ========== */
    body.light-mode {
      background: radial-gradient(circle at top, #f1f5f9, #e2e8f0);
      color: #1e293b;
    }

    /* Override Text Colors in Light Mode */
    body.light-mode .text-slate-100,
    body.light-mode .text-slate-200,
    body.light-mode .text-slate-300,
    body.light-mode .text-slate-400 {
      color: #334155 !important;
    }
    
    body.light-mode .text-slate-500 {
      color: #64748b !important;
    }

    /* Override Backgrounds & Borders in Light Mode */
    body.light-mode .glass {
      background: rgba(255, 255, 255, 0.85);
      border: 1px solid rgba(203, 213, 225, 0.8);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    body.light-mode .bg-slate-900,
    body.light-mode .bg-slate-950,
    body.light-mode .bg-slate-900\/70,
    body.light-mode .bg-slate-900\/80,
    body.light-mode .bg-slate-950\/60,
    body.light-mode .bg-slate-950\/80,
    body.light-mode .bg-slate-900\/95 {
      background-color: #ffffff !important;
      border-color: #e2e8f0 !important;
    }

    /* Buttons & Inputs in Light Mode */
    body.light-mode .btn-ghost {
      background-color: #f8fafc !important;
      color: #334155 !important;
      border-color: #cbd5e1 !important;
    }
    
    body.light-mode input,
    body.light-mode select,
    body.light-mode textarea {
      background-color: #f8fafc !important;
      color: #0f172a !important;
      border: 1px solid #cbd5e1 !important;
    }

    body.light-mode .badge-pill {
      background-color: #f1f5f9 !important;
      border-color: #cbd5e1 !important;
      color: #475569 !important;
    }
    
    /* Song List Items Light Mode */
    body.light-mode #songList button {
      background-color: #ffffff !important;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    
    /* Tab Buttons Active State Fix for Light Mode */
    body.light-mode .tab-btn.bg-slate-100 {
      background-color: #0f172a !important; 
      color: #f8fafc !important;
    }

    /* ========== BIBLE FIXES FOR LIGHT MODE ========== */
    /* Header ko solid white aur shadow dene ke liye */
    body.light-mode .bible-header-fix {
      background-color: rgba(255, 255, 255, 0.95) !important;
      border-bottom: 1px solid #e2e8f0 !important;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
      color: #0f172a !important;
    }
    
    body.light-mode .bible-label {
      color: #64748b !important;
    }
    
    /* Light mode me verse highlight alag dikhe */
    body.light-mode .bg-emerald-900\/50 {
      background-color: #bbf7d0 !important; /* Light green */
    }
    body.light-mode .text-emerald-400, 
    body.light-mode .text-emerald-500 {
      color: #059669 !important; /* Darker green text */
    }
  </style>
</head>

<body class="min-h-screen text-slate-100 flex flex-col">
  <div class="max-w-4xl mx-auto px-3 py-4 sm:py-6 flex-grow w-full">
    <header class="mb-4">
      <div class="flex items-center justify-between gap-3">
        <div>
          <h1 class="text-xl sm:text-2xl font-bold tracking-tight flex items-center gap-2">
            <i class="fa-solid fa-church text-blue-400"></i>
            Worship App
          </h1>
          <p class="text-xs sm:text-sm text-slate-400">
            CNI Emmanuel Church, Mirzapur
          </p>
        </div>
        
        <div class="flex items-center gap-2">
          <button id="themeToggleBtn" class="btn-ghost px-3 py-1.5 flex items-center gap-2 rounded-xl border border-slate-600/50">
             </button>

          <button id="installPwaButton" class="btn-install">
            <i class="fa-solid fa-download"></i>
            Install App
          </button>
        </div>
      </div>

      <div
        class="mt-4 grid grid-cols-3 sm:grid-cols-5 gap-2 text-[11px] sm:text-xs font-medium bg-slate-900/70 rounded-2xl p-1 border border-slate-800">
        <button data-screen="home"
          class="tab-btn rounded-xl px-2 py-1.5 flex items-center justify-center gap-1 bg-slate-100 text-slate-900">
          <i class="fa-solid fa-list-ul text-[11px]"></i>
          <span>Songs</span>
        </button>
        <button data-screen="aradhana"
          class="tab-btn rounded-xl px-2 py-1.5 flex items-center justify-center gap-1 text-slate-200">
          <i class="fa-solid fa-hands-praying text-[11px]"></i>
          <span>Aradhana</span>
        </button>
        <button data-screen="prabhuBhoj"
          class="tab-btn rounded-xl px-2 py-1.5 flex items-center justify-center gap-1 text-slate-200">
          <i class="fa-solid fa-bread-slice text-[11px]"></i>
          <span>Prabhu Bhoj</span>
        </button>
        <button data-screen="bible"
          class="tab-btn rounded-xl px-2 py-1.5 flex items-center justify-center gap-1 text-slate-200">
          <i class="fa-solid fa-book-bible text-[11px]"></i>
          <span>Bible</span>
        </button>
        <button data-screen="admin"
          class="tab-btn rounded-xl px-2 py-1.5 flex items-center justify-center gap-1 text-slate-200">
          <i class="fa-solid fa-lock text-[11px]"></i>
          <span>Admin</span>
        </button>
      </div>
    </header>

    <main class="glass rounded-3xl p-4 sm:p-6 shadow-xl shadow-slate-900/40 space-y-4 min-h-[60vh]">

      <section id="homeScreen" class="space-y-4">
        <div class="flex flex-col sm:flex-row sm:items-center gap-3">
          <div class="relative flex-1">
            <input id="searchInput" type="text" placeholder="Search song / number / keyword..."
              class="w-full rounded-2xl bg-slate-900/80 border border-slate-700 px-4 py-2.5 text-sm pr-9 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 placeholder:text-slate-500">
            <span class="absolute right-3 top-2.5 text-slate-500 text-xs">
              <i class="fa-solid fa-magnifying-glass"></i>
            </span>
          </div>
          <div class="flex items-center gap-2 text-[11px]">
            <select id="languageFilter"
              class="rounded-2xl bg-slate-900/80 border border-slate-700 px-3 py-2 text-[11px] focus:outline-none focus:ring-1 focus:ring-blue-500">
              <option value="all">All</option>
              <option value="hindi">Hindi</option>
              <option value="hinglish">Hinglish</option>
            </select>
            <button id="favoriteToggle"
              class="btn-ghost h-9 px-3 flex items-center gap-1 text-[11px]">
              <i class="fa-regular fa-star"></i>
              <span>Favourites</span>
            </button>
          </div>
        </div>

        <div id="songList"
          class="max-h-[60vh] overflow-y-auto scrollbar-thin space-y-2 text-sm">
          <p class="text-xs text-slate-400">
            Loading songs...
          </p>
        </div>
      </section>

      <section id="songDetailScreen" class="hidden space-y-4">
        <div class="flex items-start justify-between gap-3">
          <div>
            <p id="songSerial"
              class="badge-pill mb-1 flex items-center gap-1">
              <i class="fa-solid fa-hashtag text-[9px]"></i>
              <span></span>
            </p>
            <h2 id="songTitleHindi" class="text-xl font-bold tracking-wide text-white text-slate-100"></h2>
            <p id="songTitleHinglish" class="text-sm text-slate-400 italic"></p>
          </div>
          <div class="flex flex-col items-end gap-2">
            <button id="toggleLanguageBtn" class="btn-ghost text-[11px]">
              Hindi
            </button>
            <button id="favoriteSongBtn"
              class="btn-ghost text-[11px] flex items-center gap-1">
              <i class="fa-regular fa-star"></i>
              <span>Favourite</span>
            </button>
          </div>
        </div>

        <article id="lyricsContainer"
          class="text-lg sm:text-xl leading-relaxed sm:leading-loose whitespace-pre-line scrollbar-thin border border-slate-700/70 rounded-2xl p-4 bg-slate-950/60 text-slate-200 font-medium mb-6">
        </article>
      </section>

      <section id="aradhanaScreen" class="hidden space-y-3 text-sm">
        <h2 class="text-lg font-semibold flex items-center gap-2 text-yellow-400">
          <i class="fa-solid fa-hands-praying"></i>
          Aradhana Section
        </h2>
        <p class="text-slate-300 text-sm leading-relaxed">
          Yahaan tum future me Aradhana ke special geet / order of service / notes add kar sakte ho. Filhaal placeholder text hai.
        </p>
      </section>

      <section id="prabhuBhojScreen" class="hidden space-y-3 text-sm">
        <h2 class="text-lg font-semibold flex items-center gap-2 text-red-400">
          <i class="fa-solid fa-bread-slice"></i>
          Prabhu Bhoj Section
        </h2>
        <p class="text-slate-300 text-sm leading-relaxed">
          Yahaan Prabhu Bhoj ke geet, readings, ya instructions laa sakte ho. Abhi basic placeholder hai.
        </p>
      </section>

      <section id="bibleScreen" class="hidden space-y-0">
        <div class="bible-header-fix sticky top-0 pt-2 pb-3 px-1 z-20 bg-slate-900/95 backdrop-blur-md border-b border-slate-800 transition-colors duration-300">
          <h2 class="text-lg font-semibold flex items-center gap-2 text-emerald-400 px-1">
            <i class="fa-solid fa-book-bible"></i>
            Pavitra Bible (Hindi)
          </h2>
          
          <div class="mt-2 grid grid-cols-3 gap-2">
            <div>
              <label class="bible-label block text-[9px] text-slate-400 mb-1 ml-1">Book</label>
              <select id="bookSelect"
                class="w-full bg-slate-950/80 border border-slate-700 rounded-lg px-2 py-1.5 text-[11px] focus:outline-none focus:ring-1 focus:ring-emerald-500">
                <option value="">Book</option>
              </select>
            </div>
            <div>
              <label class="bible-label block text-[9px] text-slate-400 mb-1 ml-1">Chap</label>
              <select id="chapterSelect"
                class="w-full bg-slate-950/80 border border-slate-700 rounded-lg px-2 py-1.5 text-[11px] focus:outline-none focus:ring-1 focus:ring-emerald-500"
                disabled>
                <option value="">Ch</option>
              </select>
            </div>
            <div>
              <label class="bible-label block text-[9px] text-slate-400 mb-1 ml-1">Verse</label>
              <select id="verseSelect"
                class="w-full bg-slate-950/80 border border-slate-700 rounded-lg px-2 py-1.5 text-[11px] focus:outline-none focus:ring-1 focus:ring-emerald-500"
                disabled>
                <option value="">Vs</option>
              </select>
            </div>
          </div>
        </div>

        <div id="bibleContent"
          class="text-lg sm:text-xl leading-relaxed sm:leading-loose whitespace-pre-line p-4 pb-20 text-slate-200 font-medium min-h-[200px]">
          <p class="text-sm text-slate-400 text-center mt-10">
            Padhne ke liye koi Book select karein.
          </p>
        </div>
      </section>

      <section id="adminScreen" class="hidden space-y-4 text-sm">
        <h2 class="text-lg font-semibold flex items-center gap-2 text-pink-400">
          <i class="fa-solid fa-user-shield"></i>
          Admin Panel
        </h2>

        <div id="adminLoginBox" class="space-y-2">
          <p class="text-xs text-slate-400">
            Sirf authorized log ke liye. PIN daalo:
          </p>
          <div class="flex gap-2">
            <input id="adminPinInput" type="password" maxlength="6"
              class="flex-1 rounded-xl bg-slate-950/80 border border-slate-700 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-pink-500"
              placeholder="PIN..." />
            <button id="adminLoginBtn" class="btn-primary text-xs px-3 bg-pink-600 hover:bg-pink-500">
              Login
            </button>
          </div>
          <p id="adminLoginError" class="hidden text-[11px] text-red-400">
            Galat PIN. Dobara try karo.
          </p>
        </div>

        <div id="adminContent" class="hidden space-y-4">
          <p class="text-xs text-slate-400 flex items-center justify-between">
            <span>Logged in as <span class="font-semibold">Admin</span></span>
            <button id="adminLogoutBtn" class="btn-ghost text-[10px]">
              Logout
            </button>
          </p>

          <div class="border border-slate-700 rounded-2xl p-3 bg-slate-950/70 space-y-3">
            <h3 class="font-semibold text-sm flex items-center gap-2">
              <i class="fa-solid fa-plus text-emerald-400 text-xs"></i>
              Naya Geet Add karo
            </h3>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
              <div>
                <label class="text-[11px] text-slate-400">Serial Number</label>
                <input id="songSerialInput" type="number"
                  class="w-full rounded-xl bg-slate-900/80 border border-slate-700 px-3 py-1.5 text-xs focus:outline-none focus:ring-2 focus:ring-blue-500" />
              </div>
              <div>
                <label class="text-[11px] text-slate-400">Title (Hindi)</label>
                <input id="songTitleHindiInput" type="text"
                  class="w-full rounded-xl bg-slate-900/80 border border-slate-700 px-3 py-1.5 text-xs focus:outline-none focus:ring-2 focus:ring-blue-500" />
              </div>
              <div>
                <label class="text-[11px] text-slate-400">Title (Hinglish)</label>
                <input id="songTitleHinglishInput" type="text"
                  class="w-full rounded-xl bg-slate-900/80 border border-slate-700 px-3 py-1.5 text-xs focus:outline-none focus:ring-2 focus:ring-blue-500" />
              </div>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
              <div>
                <label class="text-[11px] text-slate-400">Lyrics (Hindi)</label>
                <textarea id="lyricsHindiInput" rows="4"
                  class="w-full rounded-xl bg-slate-900/80 border border-slate-700 px-3 py-1.5 text-xs focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
              </div>
              <div>
                <label class="text-[11px] text-slate-400">Lyrics (Hinglish)</label>
                <textarea id="lyricsHinglishInput" rows="4"
                  class="w-full rounded-xl bg-slate-900/80 border border-slate-700 px-3 py-1.5 text-xs focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
              </div>
            </div>

            <button id="addSongBtn" class="btn-primary w-full text-xs">
              Save Song
            </button>
            <p id="adminStatusMsg" class="text-[11px] text-emerald-400 hidden"></p>
          </div>

          <div class="text-[11px] text-slate-500">
            Note: Sab geet Firestore ke <code class="text-[10px] bg-slate-900 px-1 rounded">songs</code> collection me
            save honge.
          </div>
        </div>
      </section>
    </main>

    <div class="text-[11px] text-slate-400 text-center mt-4">
      App created for (CNI) Emmanuel Church, Mirzapur.<br>
      By : <span class="text-blue-400 font-semibold">Abhishek Masih</span> • 2025
    </div>
    <footer class="text-[11px] text-slate-500 text-center mt-3 pb-4 pt-3 border-t border-slate-700/40">
      Worship App • Designed & Developed by 
      <span class="text-blue-400 font-semibold">Abhishek Masih</span><br>
      © 2025 All Rights Reserved
    </footer>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>

  <script>
    // ========== FIREBASE CONFIG ==========
    const firebaseConfig = {
      apiKey: "AIzaSyCbn4wCltG1YrrfmUeoOmOvzzQsyxZVkhY",
      authDomain: "worship-3eedf.firebaseapp.com",
      projectId: "worship-3eedf",
      storageBucket: "worship-3eedf.firebasestorage.app",
      messagingSenderId: "1000732372247",
      appId: "1:1000732372247:web:ec746fc5db5dabd35a1b52"
    };

    let db;
    let app;

    try {
      app = firebase.initializeApp(firebaseConfig);
      db = firebase.firestore();
    } catch (e) {
      console.error("Firebase initialization error:", e);
      if (e.code === 'INVALID_CONFIG_KEYS') {
        alert("Firebase Config Error!");
      }
    }

    // ========== DOM ELEMENTS ==========
    const tabs = document.querySelectorAll('.tab-btn');
    const screens = {
      home: document.getElementById('homeScreen'),
      songDetail: document.getElementById('songDetailScreen'),
      aradhana: document.getElementById('aradhanaScreen'),
      prabhuBhoj: document.getElementById('prabhuBhojScreen'),
      bible: document.getElementById('bibleScreen'),
      admin: document.getElementById('adminScreen')
    };

    const searchInput = document.getElementById('searchInput');
    const languageFilter = document.getElementById('languageFilter');
    const favoriteToggle = document.getElementById('favoriteToggle');
    const songList = document.getElementById('songList');

    // Song detail
    const songDetailScreen = screens.songDetail;
    const songSerialEl = document.getElementById('songSerial').querySelector('span');
    const songTitleHindiEl = document.getElementById('songTitleHindi');
    const songTitleHinglishEl = document.getElementById('songTitleHinglish');
    const lyricsContainer = document.getElementById('lyricsContainer');
    const toggleLanguageBtn = document.getElementById('toggleLanguageBtn');
    const favoriteSongBtn = document.getElementById('favoriteSongBtn');

    // Bible
    const bibleScreen = screens.bible;
    const bookSelect = document.getElementById('bookSelect');
    const chapterSelect = document.getElementById('chapterSelect');
    const verseSelect = document.getElementById('verseSelect');
    const bibleContent = document.getElementById('bibleContent');

    // Admin
    const adminScreen = screens.admin;
    const adminLoginBox = document.getElementById('adminLoginBox');
    const adminContent = document.getElementById('adminContent');
    const adminPinInput = document.getElementById('adminPinInput');
    const adminLoginBtn = document.getElementById('adminLoginBtn');
    const adminLoginError = document.getElementById('adminLoginError');
    const adminLogoutBtn = document.getElementById('adminLogoutBtn');
    const songSerialInput = document.getElementById('songSerialInput');
    const songTitleHindiInput = document.getElementById('songTitleHindiInput');
    const songTitleHinglishInput = document.getElementById('songTitleHinglishInput');
    const lyricsHindiInput = document.getElementById('lyricsHindiInput');
    const lyricsHinglishInput = document.getElementById('lyricsHinglishInput');
    const addSongBtn = document.getElementById('addSongBtn');
    const adminStatusMsg = document.getElementById('adminStatusMsg');

    // Install Button & Theme Button
    const installPwaButton = document.getElementById('installPwaButton');
    const themeToggleBtn = document.getElementById('themeToggleBtn');

    // ========== STATE ==========
    let allSongs = [];
    let filteredSongs = [];
    let favoritesOnly = false;
    let currentSong = null;
    let currentLanguage = 'hindi';
    let bibleData = [];
    let currentBibleBook = null;
    const ADMIN_PIN = '1844';
    let isAdmin = false;
    let isDarkMode = true;

    // ========== THEME LOGIC ==========
    function initTheme() {
      const storedTheme = localStorage.getItem('theme');
      if (storedTheme === 'light') {
        isDarkMode = false;
        document.body.classList.add('light-mode');
      } else {
        isDarkMode = true;
        document.body.classList.remove('light-mode');
      }
      updateThemeIcon(isDarkMode);
    }

    function updateThemeIcon(isDark) {
        if (isDark) {
            themeToggleBtn.innerHTML = `
                <i class="fa-solid fa-sun text-yellow-400 text-base"></i>
                <span class="text-[11px] font-medium text-slate-300 hidden sm:inline">Light</span>
            `;
        } else {
            themeToggleBtn.innerHTML = `
                <i class="fa-solid fa-moon text-slate-600 text-base"></i>
                <span class="text-[11px] font-medium text-slate-700 hidden sm:inline">Dark</span>
            `;
        }
    }

    if (themeToggleBtn) {
        themeToggleBtn.addEventListener('click', () => {
            isDarkMode = !isDarkMode;
            
            if (isDarkMode) {
                document.body.classList.remove('light-mode');
                localStorage.setItem('theme', 'dark');
            } else {
                document.body.classList.add('light-mode');
                localStorage.setItem('theme', 'light');
            }
            updateThemeIcon(isDarkMode);
        });
    }
    
    initTheme();


    // ========== HELPERS ==========
    function getFavoriteIds() {
      try {
        const raw = localStorage.getItem('favoriteSongs');
        return raw ? JSON.parse(raw) : [];
      } catch (e) { return []; }
    }

    function setFavoriteIds(ids) {
      localStorage.setItem('favoriteSongs', JSON.stringify(ids));
    }

    function isFavorite(id) {
      return getFavoriteIds().includes(id);
    }

    function toggleFavorite(id) {
      const ids = getFavoriteIds();
      const index = ids.indexOf(id);
      if (index === -1) ids.push(id);
      else ids.splice(index, 1);
      setFavoriteIds(ids);
    }

    function setActiveTab(screenName) {
      tabs.forEach(btn => {
        if (btn.dataset.screen === screenName) {
          btn.classList.add('bg-slate-100', 'text-slate-900');
        } else {
          btn.classList.remove('bg-slate-100', 'text-slate-900');
        }
      });
    }

    function showScreen(screenName) {
      Object.values(screens).forEach(sec => sec.classList.add('hidden'));
      if (screenName === 'home') {
        screens.home.classList.remove('hidden');
        songDetailScreen.classList.add('hidden');
      } else if (screenName === 'songDetail') {
        screens.home.classList.add('hidden');
        songDetailScreen.classList.remove('hidden');
      } else {
        const sec = screens[screenName];
        if (sec) sec.classList.remove('hidden');
        songDetailScreen.classList.add('hidden');
      }
      setActiveTab(screenName === 'songDetail' ? 'home' : screenName);
      window.scrollTo(0, 0);
    }

    // ========== SONGS (FIRESTORE) ==========
    async function loadSongs() {
      if (typeof db === 'undefined') return;
      try {
        const snapshot = await db.collection('songs').orderBy('serialNumber').get();
        allSongs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        applySongFilters();
      } catch (error) {
        console.error('Error loading songs:', error);
        songList.innerHTML = '<p class="text-xs text-red-400">Geet load nahi ho paye.</p>';
      }
    }

    function applySongFilters() {
      const query = (searchInput.value || '').toLowerCase();
      const lang = languageFilter.value;
      const favIds = getFavoriteIds();

      filteredSongs = allSongs.filter(song => {
        if (favoritesOnly && !favIds.includes(song.id)) return false;
        if (lang === 'hindi' && !song.title_hindi) return false;
        if (lang === 'hinglish' && !song.title_hinglish) return false;

        if (!query) return true;
        const num = (song.serialNumber || '').toString();
        const h = (song.title_hindi || '').toLowerCase();
        const r = (song.title_hinglish || '').toLowerCase();
        const lh = (song.lyrics_hindi || '').toLowerCase();
        
        return (num.includes(query) || h.includes(query) || r.includes(query) || lh.includes(query));
      });
      renderSongList();
    }

    function renderSongList() {
      if (!filteredSongs.length && allSongs.length > 0) {
        songList.innerHTML = '<p class="text-xs text-slate-400 text-center mt-10">Koi geet nahi mila.</p>';
        return;
      }
      if (!allSongs.length) {
        songList.innerHTML = '<p class="text-xs text-slate-400 text-center mt-10">Loading songs...</p>';
        return;
      }

      const favIds = getFavoriteIds();
      songList.innerHTML = '';
      filteredSongs.forEach(song => {
        const li = document.createElement('button');
        li.className = 'w-full flex items-start gap-3 px-3 py-3 rounded-2xl bg-slate-900/70 hover:bg-slate-800/80 border border-slate-800 text-left transition';
        li.innerHTML = `
          <div class="mt-0.5">
            <span class="badge-pill flex items-center gap-1">
              <i class="fa-solid fa-hashtag text-[9px]"></i>
              <span>${song.serialNumber ?? ''}</span>
            </span>
          </div>
          <div class="flex-1 min-w-0">
            <p class="text-sm font-bold truncate text-slate-200">
              ${song.title_hindi || 'Untitled'}
            </p>
            <p class="text-[11px] text-slate-400 truncate">
              ${song.title_hinglish || ''}
            </p>
          </div>
          <div class="flex flex-col items-end gap-1">
            <i class="${favIds.includes(song.id) ? 'fa-solid' : 'fa-regular'} fa-star text-[12px] ${favIds.includes(song.id) ? 'text-yellow-400' : 'text-slate-500'}"></i>
          </div>
        `;
        li.addEventListener('click', () => openSongDetail(song.id));
        songList.appendChild(li);
      });
    }

    function openSongDetail(id, pushHistory = true) {
      const song = allSongs.find(s => s.id === id);
      if (!song) return;
      currentSong = song;

      const hasHindi = song.lyrics_hindi && song.lyrics_hindi.trim().length > 0;
      currentLanguage = hasHindi ? 'hindi' : 'hinglish';

      songSerialEl.textContent = song.serialNumber ?? '';
      songTitleHindiEl.textContent = song.title_hindi || '';
      songTitleHinglishEl.textContent = song.title_hinglish || '';

      toggleLanguageBtn.textContent = currentLanguage === 'hindi' ? 'Hindi' : 'Hinglish';
      renderLyrics();
      updateFavoriteButton(isFavorite(song.id));
      showScreen('songDetail');

      if (pushHistory) {
        history.pushState({ view: 'songDetail', id: id }, '', '#song');
      }
    }

    function renderLyrics() {
      if (!currentSong) return;
      let text = currentLanguage === 'hindi' ? currentSong.lyrics_hindi || '' : currentSong.lyrics_hinglish || '';
      if (!text) text = 'Lyrics available nahi hain.';
      lyricsContainer.textContent = text;
    }

    function updateFavoriteButton(isFav) {
      favoriteSongBtn.classList.toggle('text-yellow-300', isFav);
      favoriteSongBtn.classList.toggle('text-slate-200', !isFav);
      favoriteSongBtn.innerHTML = `
        <i class="${isFav ? 'fa-solid' : 'fa-regular'} fa-star"></i>
        <span>${isFav ? 'Favourite' : 'Favourite'}</span>
      `;
    }

    // ========== BIBLE UPDATED LOGIC ==========
    async function loadBibleData() {
      try {
        const response = await fetch('./bible.json');
        if (!response.ok) throw new Error('File not found');
        
        const jsonData = await response.json();
        bibleData = jsonData.bible || jsonData; 
        
        populateBookSelect();

        if (bibleData.length > 0) {
          bookSelect.value = "0"; 
          handleBookChange(true); 
        }
      } catch (error) {
        console.error('Bible load error:', error);
        bibleContent.innerHTML = '<p class="text-center mt-10 text-red-400">Bible download nahi ho payi.</p>';
      }
    }

    function populateBookSelect() {
      bookSelect.innerHTML = '<option value="">Book</option>'; 
      bibleData.forEach((book, index) => {
        const opt = document.createElement('option');
        opt.value = index;
        opt.textContent = book.book_name || book.book || book.name;
        bookSelect.appendChild(opt);
      });
      chapterSelect.innerHTML = '<option value="">Ch</option>';
      chapterSelect.disabled = true;
      verseSelect.innerHTML = '<option value="">Vs</option>';
      verseSelect.disabled = true;
      bibleContent.innerHTML = '<p class="text-center mt-10 text-slate-500">Upar kitab chunein.</p>';
    }

    function handleBookChange(isDefaultLoad = false) { 
      const index = parseInt(bookSelect.value, 10);
      if (isNaN(index)) {
        currentBibleBook = null;
        chapterSelect.disabled = true;
        verseSelect.disabled = true;
        return;
      }

      currentBibleBook = bibleData[index];
      
      chapterSelect.disabled = false;
      chapterSelect.innerHTML = '<option value="">Ch</option>';
      
      const chapters = currentBibleBook.chapters || [];
      chapters.forEach(ch => {
        const opt = document.createElement('option');
        const chNum = ch.chapter_no || ch.chapter || ch.id;
        opt.value = chNum;
        opt.textContent = chNum;
        chapterSelect.appendChild(opt);
      });

      verseSelect.innerHTML = '<option value="">Vs</option>';
      verseSelect.disabled = true;

      // AUTO CHAPTER 1 LOAD LOGIC
      if (chapters.length > 0) {
        const firstChapterVal = chapters[0].chapter_no || chapters[0].chapter || chapters[0].id;
        chapterSelect.value = firstChapterVal;
        handleChapterChange(); 
      }
    }

    function handleChapterChange() {
      if (!currentBibleBook) return;
      const chapterNum = parseInt(chapterSelect.value, 10);
      
      const chapterObj = currentBibleBook.chapters.find(
        ch => (ch.chapter_no || ch.chapter || ch.id) == chapterNum
      );
      
      if (!chapterObj) return;

      verseSelect.disabled = false;
      verseSelect.innerHTML = '<option value="">All</option>';
      
      const verses = chapterObj.verses || [];
      verses.forEach(v => {
        const opt = document.createElement('option');
        let vNum = v.verse_no || v.verse;
        if(typeof vNum === 'string' && vNum.length > 5) vNum = v.verse_no;

        opt.value = vNum;
        opt.textContent = vNum;
        verseSelect.appendChild(opt);
      });

      // Default render all verses
      renderVerses(chapterObj, null);
    }

    function handleVerseChange() {
      if (!currentBibleBook) return;
      const chapterNum = parseInt(chapterSelect.value, 10);
      const chapterObj = currentBibleBook.chapters.find(
        ch => (ch.chapter_no || ch.chapter || ch.id) == chapterNum
      );
      if (!chapterObj) return;

      const val = verseSelect.value;
      renderVerses(chapterObj, val);
    }

    // UPDATED RENDER FUNCTION
    function renderVerses(chapterObj, targetVerseNum) {
      bibleContent.innerHTML = '';

      const bName = currentBibleBook.book_name || currentBibleBook.book;
      const cNum = chapterObj.chapter_no || chapterObj.chapter;

      // NO STICKY TITLE (Clean scroll)
      const title = document.createElement('h3');
      title.className = 'text-2xl font-bold text-emerald-500 mb-6 mt-2 border-b border-emerald-900/30 pb-2 px-2';
      title.textContent = `${bName} - ${cNum}`;
      bibleContent.appendChild(title);

      const container = document.createElement('div');
      container.className = 'space-y-6 text-lg sm:text-xl leading-loose text-slate-200 px-1';

      const verses = chapterObj.verses || [];

      if(verses.length === 0) {
        bibleContent.innerHTML += "<p class='text-center mt-5 text-slate-500'>Aayat nahi mili.</p>";
        return;
      }

      verses.forEach(v => {
        const p = document.createElement('p');
        const vNum = v.verse_no || (typeof v.verse !== 'string' ? v.verse : v.verse_no);
        const vText = v.text || v.verse; 
        
        // Add ID for Scrolling & better styling
        p.id = `verse-${vNum}`;
        p.className = "transition-colors duration-1000 p-2 rounded hover:bg-slate-800/30 border-l-2 border-transparent hover:border-emerald-500/30"; 

        p.innerHTML = `<span class="text-emerald-500 font-bold mr-2 text-sm bg-emerald-900/20 px-2 py-0.5 rounded-full select-none">${vNum}</span>${vText}`;
        container.appendChild(p);
      });

      bibleContent.appendChild(container);

      // SCROLL TO TARGET VERSE
      if (targetVerseNum && targetVerseNum !== "" && targetVerseNum !== "All") {
        setTimeout(() => {
          const targetEl = document.getElementById(`verse-${targetVerseNum}`);
          if (targetEl) {
            // Add scroll margin so it doesn't hide behind the sticky header
            targetEl.style.scrollMarginTop = "160px";
            targetEl.scrollIntoView({ behavior: 'smooth' });
            targetEl.classList.add('bg-emerald-900/50');
            setTimeout(() => {
              targetEl.classList.remove('bg-emerald-900/50');
            }, 2000);
          }
        }, 100);
      }
    }

    // ========== ADMIN ==========
    function updateAdminUI() {
      if (isAdmin) {
        adminLoginBox.classList.add('hidden');
        adminContent.classList.remove('hidden');
      } else {
        adminLoginBox.classList.remove('hidden');
        adminContent.classList.add('hidden');
      }
    }
    function showAdminStatus(msg, isError = false) {
      adminStatusMsg.textContent = msg;
      adminStatusMsg.classList.remove('hidden');
      adminStatusMsg.classList.toggle('text-red-400', isError);
      adminStatusMsg.classList.toggle('text-emerald-400', !isError);
      setTimeout(() => { adminStatusMsg.classList.add('hidden'); }, 3000);
    }

    async function addSong() {
      if (typeof db === 'undefined') {
        showAdminStatus('Database Error', true);
        return;
      }
      const serial = parseInt(songSerialInput.value, 10);
      const titleH = songTitleHindiInput.value.trim();
      const titleR = songTitleHinglishInput.value.trim();
      const lyrH = lyricsHindiInput.value.trim();
      const lyrR = lyricsHinglishInput.value.trim();

      if (!serial || !titleH) {
        showAdminStatus('Serial No & Title zaroori hai', true);
        return;
      }
      try {
        await db.collection('songs').add({
          serialNumber: serial,
          title_hindi: titleH,
          title_hinglish: titleR,
          lyrics_hindi: lyrH,
          lyrics_hinglish: lyrR
        });
        showAdminStatus('Geet Save Ho Gaya ✅');
        songSerialInput.value = '';
        songTitleHindiInput.value = '';
        songTitleHinglishInput.value = '';
        lyricsHindiInput.value = '';
        lyricsHinglishInput.value = '';
        loadSongs();
      } catch (error) {
        console.error('Add song error:', error);
        showAdminStatus('Error Saving Song', true);
      }
    }

    // ========== INSTALL & INIT ==========
    let deferredPrompt = null;
    const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;

    if (!isStandalone) {
        if (installPwaButton) installPwaButton.classList.remove('hidden');
    } else {
        if (installPwaButton) installPwaButton.classList.add('hidden');
    }

    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      if (installPwaButton) installPwaButton.classList.remove('hidden');
    });

    if (installPwaButton) {
      installPwaButton.addEventListener('click', async () => {
        if (deferredPrompt) {
          deferredPrompt.prompt();
          const { outcome } = await deferredPrompt.userChoice;
          deferredPrompt = null;
          if (outcome === 'accepted') {
            installPwaButton.classList.add('hidden');
          }
        } else {
          alert("Install karne ke liye:\nBrowser Menu (⋮) > 'Install App' / 'Add to Home Screen'");
        }
      });
    }

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').catch(console.error);
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      tabs.forEach(btn => {
        btn.addEventListener('click', () => {
          const screen = btn.dataset.screen;
          if (screen === 'home') showScreen('home');
          if (screen === 'aradhana') showScreen('aradhana');
          if (screen === 'prabhuBhoj') showScreen('prabhuBhoj');
          if (screen === 'bible') {
            showScreen('bible');
            if (!bibleData.length) loadBibleData();
          }
          if (screen === 'admin') showScreen('admin');
        });
      });
      
      window.addEventListener('popstate', (event) => {
         if (!songDetailScreen.classList.contains('hidden')) {
            showScreen('home');
         }
      });

      searchInput.addEventListener('input', applySongFilters);
      languageFilter.addEventListener('change', applySongFilters);

      favoriteToggle.addEventListener('click', () => {
        favoritesOnly = !favoritesOnly;
        favoriteToggle.classList.toggle('bg-yellow-400/20', favoritesOnly);
        favoriteToggle.classList.toggle('border-yellow-400/60', favoritesOnly);
        favoriteToggle.innerHTML = favoritesOnly
          ? '<i class="fa-solid fa-star text-yellow-300"></i><span>Only favourites</span>'
          : '<i class="fa-regular fa-star"></i><span>Favourites</span>';
        applySongFilters();
      });

      toggleLanguageBtn.addEventListener('click', () => {
        currentLanguage = currentLanguage === 'hindi' ? 'hinglish' : 'hindi';
        toggleLanguageBtn.textContent = currentLanguage === 'hindi' ? 'Hindi' : 'Hinglish';
        renderLyrics();
      });

      favoriteSongBtn.addEventListener('click', () => {
        if (!currentSong) return;
        toggleFavorite(currentSong.id);
        updateFavoriteButton(isFavorite(currentSong.id));
        applySongFilters();
      });

      bookSelect.addEventListener('change', () => handleBookChange(false));
      chapterSelect.addEventListener('change', handleChapterChange);
      verseSelect.addEventListener('change', handleVerseChange);

      adminLoginBtn.addEventListener('click', () => {
        if (adminPinInput.value.trim() === ADMIN_PIN) {
          isAdmin = true;
          adminLoginError.classList.add('hidden');
          adminPinInput.value = '';
          updateAdminUI();
        } else {
          adminLoginError.classList.remove('hidden');
        }
      });

      adminLogoutBtn.addEventListener('click', () => {
        isAdmin = false;
        updateAdminUI();
      });

      addSongBtn.addEventListener('click', addSong);

      updateAdminUI();
      loadSongs();
      showScreen('home');
    });
  </script>
</body>
</html>